# HifiShifter

[中文](README.md) | [English](README_en.md)

HifiShifter 是一个基于深度学习神经声码器（NSF-HiFiGAN）的图形化人声编辑与合成工具。它允许你加载音频，在钢琴卷帘上直接编辑参数曲线（例如音高、张力），并用预训练声码器实时/增量合成修改后的音频。

## 功能概览

- **多参数编辑**：不仅可编辑音高（Pitch/Note），也支持编辑张力（Tension），并为后续扩展更多参数预留了抽象接口。
- **选区编辑（通用抽象）**：支持框选采样点、高亮显示选中段，并可拖拽整体上下偏移（对当前参数生效）。
- **长音频增量合成**：自动分段（基于静音/片段策略），只对脏片段重合成，保证交互流畅。
- **工程管理**：保存/加载工程（`.hsp`），包含音频路径、模型路径与编辑数据。
- **播放与导出**：播放原音/合成音；导出 WAV（支持混合或分轨，取决于当前 GUI 功能入口）。
- **实时播放混音**：播放过程中调整音量推子、静音轨道、独奏轨道可即时生效（无需停止重播）。
- **多语言（i18n）与主题**：支持中英文与深色/浅色主题。


## 安装

### 1. 克隆仓库

```bash
git clone https://github.com/ARounder-183/HiFiShifter.git
cd HifiShifter
```

### 2. 安装依赖

请确保已安装 Python 3.10+。

```bash
pip install -r requirements.txt
```

## 快速开始

1. **运行程序**

```bash
python run_gui.py
```

2. **加载模型**
- 点击 `文件` -> `加载模型`。
- 选择包含 `model.ckpt` 和 `config.json` 的文件夹。
- 默认提供的模型：`pc_nsf_hifigan_44.1k_hop512_128bin_2025.02`。

3. **加载音频**
- 点击 `文件` -> `加载音频`。
- 支持 `.wav` / `.flac` / `.mp3`。

4. **编辑与合成**
- 在顶部栏使用 `编辑:` 下拉框选择要编辑的参数（音高/张力）。
- 编辑区内也提供参数切换按钮（与顶部下拉框保持同步）。
- 点击 `播放` -> `合成并播放` 听取效果。

## 编辑模式与选区模式

### 编辑模式（Edit）
- **左键**：编辑当前参数的曲线（随参数面板切换）。
- **右键**：擦除/还原当前参数的编辑点（具体行为取决于参数实现：音高通常回到原始/空值，张力通常回到默认/零值）。

### 选区模式（Select）
- **左键拖拽框选**：对当前参数生成选区。
- **选中高亮**：被选中的采样点会以高亮曲线显示（通用于所有参数，不再仅限音高）。
- **拖拽选区上下移动**：对选中点整体施加偏移（对当前参数生效）。

## 轴显示（随参数切换）

- 当编辑 **音高** 时：左侧 Y 轴显示音名刻度（Note），并使用音高语义（如 C4、D#4）。
- 当编辑 **张力** 等线性参数时：左侧 Y 轴切换为数值刻度（linear），同时左侧竖向标题也会随参数切换。

该机制已抽象化：后续新增参数时，只需补充参数的「轴类型/映射/格式化」实现即可复用现有 UI。

## 常用快捷键

| 操作 | 快捷键 / 鼠标动作 |
| :-- | :-- |
| **平移视图** | 鼠标中键拖动 |
| **横向缩放（时间）** | Ctrl + 鼠标滚轮 |
| **纵向缩放（参数）** | Alt + 鼠标滚轮 |
| **编辑当前参数** | 鼠标左键 |
| **擦除/还原当前参数** | 鼠标右键 |
| **播放/暂停** | Space（空格） |
| **撤销** | Ctrl + Z |
| **重做** | Ctrl + Y |
| **切换模式（编辑/选区）** | Tab |

## 开发者说明（与本次重构相关）

### 音频处理模块化拆分

为提升可读性与调试效率，音频处理逻辑已从单文件拆分为“编排入口 + 子处理模块”结构：

- `hifi_shifter/audio_processor.py`
  - 仍作为对外入口（GUI 主要调用点），负责流程编排与保持 API 稳定。
- `hifi_shifter/audio_processing/`
  - `features.py`：音频加载/特征提取与分段相关逻辑。
  - `hifigan_infer.py`：NSF-HiFiGAN 推理相关逻辑。
  - `tension_fx.py`：张力后处理（post-FX）相关逻辑。
  - `_bootstrap.py`：启动上下文兼容（确保仓库根目录在 `sys.path`，避免 `training/` 等导入失败）。

### 选中高亮与参数扩展抽象

- 选区数据由 `selection_mask` + `selection_param` 管理，避免跨参数串扰。
- 高亮曲线已抽象为通用的 `selected_param_curve_item`：当前参数变化后会自动刷新。

## 已知问题

目前仍存在一些问题，例如导入长音频在部分环境下可能卡死、多轨/高采样率下资源占用较高等。


## 文档

- [开发手册](DEVELOPMENT_zh.md)
- [更新计划](todo.md)

## 致谢

本项目使用了以下开源库的代码或模型结构：
- [SingingVocoders](https://github.com/openvpi/SingingVocoders)
- [HiFi-GAN](https://github.com/jik876/hifi-gan)

## License

MIT License
