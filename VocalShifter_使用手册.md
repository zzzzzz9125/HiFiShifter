# Vocal Shifter 使用手册与技术文档

本文档详细介绍了 Vocal Shifter 音高修正工具的功能、技术细节、模型参数以及工程文件结构。

## 1. 简介

Vocal Shifter 是一个基于深度学习神经声码器（NSF-HiFiGAN）的图形化音高修正工具。它允许用户加载音频文件，在钢琴卷帘界面上直观地编辑音高曲线，并利用预训练的声码器模型实时合成修改后的音频。该工具特别适合歌声合成（SVS）领域的音高调整和实验。

## 2. 功能特性

*   **可视化编辑**: 提供直观的钢琴卷帘（Piano Roll）界面，支持鼠标绘制、擦除音高曲线。
*   **实时合成**: 基于 NSF-HiFiGAN 模型，能够高质量地将修改后的音高和原始频谱合成为波形。
*   **长音频优化**: 内置智能分段算法，自动识别静音区将长音频切分。编辑时仅重算受影响的片段，极大降低了显存占用并提高了响应速度。
*   **工程管理**: 支持保存和读取 `.vsp` (JSON) 格式的工程文件，随时保存工作进度。
*   **音频导出**: 支持将处理后的音频导出为标准 WAV 格式。
*   **交互优化**: 支持撤销/重做 (Undo/Redo)、快捷键操作、时间轴点击定位、中键平移视图等 DAW 级交互体验。

## 3. 模型输入参数详解

本工具的核心是 `AudioProcessor` 模块，它负责数据的预处理和模型推理。NSF-HiFiGAN 模型的输入主要包含两部分：

### 3.1. Mel 频谱图 (Mel Spectrogram)
*   **来源**: 从原始音频中提取。
*   **作用**: 提供音频的音色、发音内容和响度信息。
*   **处理流程**:
    1.  加载音频并重采样至模型配置的采样率（通常为 44.1kHz 或 24kHz）。
    2.  进行短时傅里叶变换 (STFT)。
    3.  映射到 Mel 刻度并取对数。
*   **关键参数** (由 `config.yaml` 定义):
    *   `n_fft`: FFT 窗口大小 (如 2048)。
    *   `hop_size`: 帧移大小 (如 512)。
    *   `num_mels`: Mel 频带数量 (如 128)。
    *   `fmin` / `fmax`: 频率范围。

### 3.2. 基频 (F0 / Fundamental Frequency)
*   **来源**: 
    1.  **初始提取**: 使用 Parselmouth (Praat) 算法从原始音频中提取 F0。
    2.  **用户编辑**: 用户在 GUI 上绘制的曲线会覆盖原始 F0。
*   **作用**: 控制合成音频的音高。
*   **数据格式**:
    *   **GUI 显示**: 使用 MIDI 音符编号 (如 69 代表 A4, 440Hz)。
    *   **模型输入**: 在送入模型前，MIDI 编号会被转换回赫兹 (Hz)。
    *   **静音处理**: 无声区域的 F0 为 0 或 NaN。

### 3.3. 推理过程
模型接收 `Mel` (内容) 和修改后的 `F0` (音高)，通过生成器 (Generator) 输出波形。
```python
# 伪代码
f0_hz = midi_to_hz(user_edited_f0_midi)
waveform = model(mel_spectrogram, f0_hz)
```

## 4. 工程文件结构说明

Vocal Shifter 的工程文件 (`.vsp`) 本质上是一个标准的 JSON 文件，记录了恢复工作环境所需的所有信息。

### 文件结构示例

```json
{
    "version": "1.0",
    "audio_path": "E:/Music/vocals/original.wav",
    "model_path": "E:/Models/nsf_hifigan_ckpt",
    "params": {
        "shift": 2.0,
        "bpm": 120.0,
        "beats": 4
    },
    "f0": [
        0.0,
        0.0,
        64.5,
        64.6,
        ...
    ]
}
```

### 字段详解

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `version` | String | 工程文件版本号，用于兼容性检查。 |
| `audio_path` | String | 原始音频文件的绝对路径。打开工程时会自动加载此文件。 |
| `model_path` | String | 模型文件夹的绝对路径。打开工程时会自动加载此模型。 |
| `params` | Object | 界面控件的参数状态。 |
| `params.shift` | Float | 全局移调半音数 (Semitones)。 |
| `params.bpm` | Float | 项目的 BPM (Beats Per Minute)，影响时间轴网格。 |
| `params.beats` | Int | 拍号 (每小节拍数)，影响时间轴网格。 |
| `f0` | Array[Float] | **核心数据**。一个浮点数数组，记录了每一帧的音高 (MIDI 标度)。<br>数组长度对应音频的总帧数。<br>`0` 或 `NaN` 表示该帧为静音/无声。 |

## 5. 快捷键列表

| 快捷键 | 功能 |
| :--- | :--- |
| **Space (空格)** | 播放 / 停止 (停止时光标返回播放起点) |
| **Esc** | 停止播放 |
| **Ctrl + Z** | 撤销上一步音高编辑 |
| **Ctrl + Shift + Z** / **Ctrl + Y** | 重做 |
| **Ctrl + O** | 打开工程 |
| **Ctrl + S** | 保存工程 |
| **Ctrl + Shift + S** | 另存为工程 |
| **鼠标左键** | 绘制/修改音高曲线 |
| **鼠标右键** | 擦除修改，恢复为原始音高 |
| **鼠标中键 (按住拖动)** | 平移视图 (Pan) |
| **Ctrl + 滚轮** | 水平缩放 (时间轴) |
| **Alt + 滚轮** | 垂直缩放 (音高轴) |

## 6. 常见问题与性能优化

### 长音频卡顿问题
*   **机制**: 软件内置了分段处理机制。当加载长音频时，会自动根据静音阈值 (`-60dB`) 和最小静音时长 (`100帧`) 将音频切分为多个片段。
*   **优势**: 当您修改某一句歌词的音高时，软件只会重新合成该句歌词对应的片段，而不是整首歌曲，从而实现秒级响应。
*   **注意**: 如果音频背景噪音过大导致无法检测到静音，可能会退化为整体合成，导致速度变慢。

### 爆音/咔哒声
*   **原因**: 分段合成时，如果边界处理不当会产生不连续。
*   **解决**: 算法在合成每个片段时，会额外读取前后 `64帧` (约0.7秒) 的数据作为上下文 (Context Padding)，合成后再裁剪掉。这确保了声码器状态的连续性，消除了拼接处的伪影。
